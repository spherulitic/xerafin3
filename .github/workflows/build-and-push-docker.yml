name: Build, Push, Deploy Docker Images

on:
  push:
    branches:
      - main
#on:
#  workflow_dispatch: # Allows manual triggering
env:
  PROD_KEYCLOAK_URL: 'https://auth.xerafin.net'

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Log in to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Detect changed containers
        run: |
           CHANGED_CONTAINERS=""
           git fetch origin main
           CHANGED_FILES=$(git diff --name-only origin/main...HEAD)
           for container in chat keycloak cron frontend lexicon lexicon-loader login quiz stats sloth cardbox; do
             if echo "$CHANGED_FILES" | grep -q "^$container/"; then
               CHANGED_CONTAINERS="$CHANGED_CONTAINERS $container"
             fi
           done
           CHANGED_CONTAINERS="${CHANGED_CONTAINERS# }"
           echo "changed_containers=$CHANGED_CONTAINERS" >> $GITHUB_ENV
           echo "Changed Containers: $CHANGED_CONTAINERS"

      - name: Increment version tags for changed containers
        if: env.changed_containers != ''
        run: |
          for container in $CHANGED_CONTAINERS; do
            CURRENT_VERSION=$(jq -r ".$container" versions.json)
            NEW_VERSION=$(echo $CURRENT_VERSION | awk -F. '{print "$1"."$2"."$3+1"}')
            jq ".$container = \"$NEW_VERSION\"" versions.json > versions.json.tmp
            mv versions.json.tmp versions.json
            echo "Updated $container to version $NEW_VERSION"
          done
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@github.com"
          git add versions.json
          git commit -m "ci: Incremented version tags for $CHANGED_CONTAINERS"
          git push

      - name: Build and Push Services
        if: env.changed_containers != ''
        run: |
          declare -A dir_to_image
          dir_to_image=(
            ["chat"]="x-chat"
            ["keycloak"]="x-keycloak"
            ["cron"]="x-cron"
            ["frontend"]="x-frontend"
            ["lexicon"]="x-lexicon"
            ["lexicon-loader"]="x-lexicon-loader"
            ["login"]="x-login"
            ["quiz"]="x-quiz"
            ["stats"]="x-stats"
            ["sloth"]="x-sloth"
            ["cardbox"]="x-cardbox"
          )
          for dir in $CHANGED_CONTAINERS; do
            echo
            echo '******************'
            echo "* BUILDING $dir  *"
            echo '******************'
            echo
            image_name="${dir_to_image[$dir]}"
            VERSION=$(jq -r ".$dir" versions.json)
            if [ "$dir" = "keycloak" ]; then
              docker build --pull -f $dir/Dockerfile.prod -t spherulitic/$image_name:$VERSION $dir
            else
              docker build --pull --build-arg NGINX_ENV=prod  --build-arg KEYCLOAK_URL=https://auth.xerafin.net -t spherulitic/$image_name:$VERSION $dir
            fi
            docker push spherulitic/$image_name:$VERSION
          done
  deploy-to-droplet:
    runs-on: ubuntu-latest
    needs: build-and-push
    env:
      CHAT_MYSQL_PWD: ${{ secrets.CHAT_MYSQL_PWD }}
      CHAT_MYSQL_USER: ${{ vars.CHAT_MYSQL_USER }}
      CHAT_MYSQL_DB: ${{ vars.CHAT_MYSQL_DB }}
      KEYCLOAK_MYSQL_PWD: ${{ secrets.KEYCLOAK_MYSQL_PWD }}
      KEYCLOAK_USER: ${{ vars.KEYCLOAK_USER }}
      KEYCLOAK_PASSWORD: ${{ secrets.KEYCLOAK_PASSWORD }}
      KC_LOGLEVEL: ${{ vars.KC_LOGLEVEL }}
      KC_DB_URL: ${{ vars.KC_DB_URL }}
      KC_DB_USERNAME: ${{ vars.KC_DB_USERNAME }}
      KC_DB_PASSWORD: ${{ secrets.KC_DB_PASSWORD }}
      LOGIN_MYSQL_PWD: ${{ secrets.LOGIN_MYSQL_PWD }}
      LOGIN_MYSQL_USER: ${{ vars.LOGIN_MYSQL_USER }}
      LOGIN_MYSQL_DB: ${{ vars.LOGIN_MYSQL_DB }}
      MONGO_INITDB_DATABASE: ${{ vars.MONGO_INITDB_DATABASE }}
      MONGO_URL: ${{ vars.MONGO_URL }}
      MYSQL_HOST: ${{ vars.MYSQL_HOST }}
      MYSQL_PORT: ${{ vars.MYSQL_PORT }}
      QUIZ_MYSQL_PWD: ${{ secrets.QUIZ_MYSQL_PWD }}
      QUIZ_MYSQL_USER: ${{ vars.QUIZ_MYSQL_USER }}
      QUIZ_MYSQL_DB: ${{ vars.QUIZ_MYSQL_DB }}
      SLOTH_MYSQL_PWD: ${{ secrets.SLOTH_MYSQL_PWD }}
      SLOTH_MYSQL_USER: ${{ vars.SLOTH_MYSQL_USER }}
      SLOTH_MYSQL_DB: ${{ vars.SLOTH_MYSQL_DB }}
      STATS_MYSQL_PWD: ${{ secrets.STATS_MYSQL_PWD }}
      STATS_MYSQL_USER: ${{ vars.STATS_MYSQL_USER }}
      STATS_MYSQL_DB: ${{ vars.STATS_MYSQL_DB }}

    steps:
      - name: Generate .env files
        run: |
          mkdir -p generated_envs
          echo MYSQL_USER=${CHAT_MYSQL_USER} > generated_envs/chat.env
          echo MYSQL_DB=${CHAT_MYSQL_DB} >> generated_envs/chat.env
          echo MYSQL_PWD=${CHAT_MYSQL_PWD} >> generated_envs/chat.env
          echo KEYCLOAK_USER=${KEYCLOAK_USER} >> generated_envs/keycloak.env
          echo KEYCLOAK_PASSWORD=${KEYCLOAK_PASSWORD} >> generated_envs/keycloak.env
          echo KC_LOGLEVEL=${KC_LOGLEVEL} >> generated_envs/keycloak.env
          echo KC_DB_URL=${KC_DB_URL} >> generated_envs/keycloak.env
          echo KC_DB_USERNAME=${KC_DB_USERNAME} >> generated_envs/keycloak.env
          echo KC_DB_PASSWORD=${KC_DB_PASSWORD} >> generated_envs/keycloak.env
          echo MONGO_INITDB_DATABASE=${MONGO_INITDB_DATABASE} > generated_envs/mongo.env
          echo MONGO_URL=${MONGO_URL} >> generated_envs/mongo.env
          echo MYSQL_HOST=${MYSQL_HOST} > generated_envs/mysql.env
          echo MYSQL_PORT=${MYSQL_PORT} >> generated_envs/mysql.env
          echo MYSQL_USER=${LOGIN_MYSQL_USER} > generated_envs/login.env
          echo MYSQL_DB=${LOGIN_MYSQL_DB} >> generated_envs/login.env
          echo MYSQL_PWD=${LOGIN_MYSQL_PWD} >> generated_envs/login.env
          echo KEYCLOAK_USER=${KEYCLOAK_USER} >> generated_envs/login.env
          echo KEYCLOAK_PASSWORD=${KEYCLOAK_PASSWORD} >> generated_envs/login.env
          echo MYSQL_USER=${QUIZ_MYSQL_USER} > generated_envs/quiz.env
          echo MYSQL_DB=${QUIZ_MYSQL_DB} >> generated_envs/quiz.env
          echo MYSQL_PWD=${QUIZ_MYSQL_PWD} >> generated_envs/quiz.env
          echo MYSQL_USER=${SLOTH_MYSQL_USER} > generated_envs/sloth.env
          echo MYSQL_DB=${SLOTH_MYSQL_DB} >> generated_envs/sloth.env
          echo MYSQL_PWD=${SLOTH_MYSQL_PWD} >> generated_envs/sloth.env
          echo MYSQL_USER=${STATS_MYSQL_USER} > generated_envs/stats.env
          echo MYSQL_DB=${STATS_MYSQL_DB} >> generated_envs/stats.env
          echo MYSQL_PWD=${STATS_MYSQL_PWD} >> generated_envs/stats.env
          ls -als

      - name: Copy .env files
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.HOST_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "generated_envs/*"
          target: "/home/spherulitic/.config/xerafin3/"
          strip_components: 1

      - name: Checkout code
        uses: actions/checkout@v6

      - name: Update quadlets with version tag
        run: |
            for container in chat keycloak cron frontend lexicon lexicon-loader login quiz stats sloth cardbox; do
              VERSION=$(jq -r ".$container" versions.json)
              sed -i "s/:latest/:$VERSION/" deploy/$container.container
            done

      - name: Copy .container files
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.HOST_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "deploy/*"
          target: "/home/spherulitic/.config/containers/systemd/"
          strip_components: 1

      - name: Copy mongo config files
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.HOST_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "lexicon-db/*"
          target: "/var/lib/xerafin/"
          strip_components: 1

      - name: Reload systemd and restart all services
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.HOST_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Pull prod images from dockerhub repo
            find ~/.config/containers/systemd/ -name '*.container' -exec sed -i 's|Image=x-|Image=docker.io/spherulitic/x-|' {} \;

            # Fixing a nonstandard dev configuration
            find ~/.config/containers/systemd/ -name '*.container' -exec sed -i 's|--runtime=/home/linuxbrew/.linuxbrew/bin/crun|--runtime=/usr/bin/crun|g' {} \;

            # Fix path to certs for keycloak
            sed -i 's|Volume=/home/spherulitic/xerafin3/frontend/ssl/dev|Volume=/etc/letsencrypt/archive/x3.xerafin.net|' ~/.config/containers/systemd/keycloak.container

            # Reload systemd to pick up unit file changes
            systemctl --user daemon-reload

            # Restart all services
            systemctl --user restart xerafin.target

            # Quick status check
            echo "Service status"
            systemctl --user --no-pager status xerafin.target --all
