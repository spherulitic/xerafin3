name: Build, Push, Deploy Docker Images

on:
  push:
    branches:
      - main
#on:
#  workflow_dispatch: # Allows manual triggering
env:
  PROD_KEYCLOAK_URL: 'https://auth.xerafin.net'

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Log in to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Services
        run: |
          declare -A dir_to_image
          dir_to_image=(
            ["chat"]="x-chat"
            ["keycloak"]="x-keycloak"
            ["cron"]="x-cron"
            ["front-end"]="x-frontend"
            ["lexicon"]="x-lexicon"
            ["lexicon-loader"]="x-lexicon-loader"
            ["login"]="x-login"
            ["quiz"]="x-quiz"
            ["stats"]="x-stats"
            ["cardbox"]="x-cardbox"
          )
          for dir in "${!dir_to_image[@]}"; do
            image_name="${dir_to_image[$dir]}"
            docker build --pull --build-arg KEYCLOAK_URL=${{env.PROD_KEYCLOAK_URL}} -t spherulitic/$image_name:latest $dir
            docker push spherulitic/$image_name:latest
          done
  deploy-to-droplet:
    runs-on: ubuntu-latest
    needs: build-and-push
    env:
      CHAT_MYSQL_PWD: ${{ secrets.CHAT_MYSQL_PWD }}
      CHAT_MYSQL_USER: ${{ vars.CHAT_MYSQL_USER }}
      CHAT_MYSQL_DB: ${{ vars.CHAT_MYSQL_DB }}
      KEYCLOAK_MYSQL_PWD: ${{ secrets.KEYCLOAK_MYSQL_PWD }}
      LOGIN_MYSQL_PWD: ${{ secrets.LOGIN_MYSQL_PWD }}
      LOGIN_MYSQL_USER: ${{ vars.LOGIN_MYSQL_USER }}
      LOGIN_MYSQL_DB: ${{ vars.LOGIN_MYSQL_DB }}
      QUIZ_MYSQL_PWD: ${{ secrets.QUIZ_MYSQL_PWD }}
      QUIZ_MYSQL_USER: ${{ vars.QUIZ_MYSQL_USER }}
      QUIZ_MYSQL_DB: ${{ vars.QUIZ_MYSQL_DB }}
      SLOTH_MYSQL_PWD: ${{ secrets.SLOTH_MYSQL_PWD }}
      SLOTH_MYSQL_USER: ${{ vars.SLOTH_MYSQL_USER }}
      SLOTH_MYSQL_DB: ${{ vars.SLOTH_MYSQL_DB }}
      STATS_MYSQL_PWD: ${{ secrets.STATS_MYSQL_PWD }}
      STATS_MYSQL_USER: ${{ vars.STATS_MYSQL_USER }}
      STATS_MYSQL_DB: ${{ vars.STATS_MYSQL_DB }}

    steps:
      - name: Generate .env files
        run: |
          mkdir -p generated_envs
          echo MYSQL_USER=${CHAT_MYSQL_USER} > generated_envs/chat.env
          echo MYSQL_DB=${CHAT_MYSQL_DB} >> generated_envs/chat.env
          echo MYSQL_PWD=${CHAT_MYSQL_PWD} >> generated_envs/chat.env
          echo MYSQL_USER=${LOGIN_MYSQL_USER} > generated_envs/login.env
          echo MYSQL_DB=${LOGIN_MYSQL_DB} >> generated_envs/login.env
          echo MYSQL_PWD=${LOGIN_MYSQL_PWD} >> generated_envs/login.env
          echo MYSQL_USER=${QUIZ_MYSQL_USER} > generated_envs/quiz.env
          echo MYSQL_DB=${QUIZ_MYSQL_DB} >> generated_envs/quiz.env
          echo MYSQL_PWD=${QUIZ_MYSQL_PWD} >> generated_envs/quiz.env
          echo MYSQL_USER=${SLOTH_MYSQL_USER} > generated_envs/sloth.env
          echo MYSQL_DB=${SLOTH_MYSQL_DB} >> generated_envs/sloth.env
          echo MYSQL_PWD=${SLOTH_MYSQL_PWD} >> generated_envs/sloth.env
          echo MYSQL_USER=${STATS_MYSQL_USER} > generated_envs/stats.env
          echo MYSQL_DB=${STATS_MYSQL_DB} >> generated_envs/stats.env
          echo MYSQL_PWD=${STATS_MYSQL_PWD} >> generated_envs/stats.env
          ls -als

      - name: Copy .env files
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.HOST_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "generated_envs/*"
          target: "/home/spherulitic/.config/xerafin3/"
          strip_components: 1

      - name: Checkout code
        uses: actions/checkout@v6

      - name: Copy .container files
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.HOST_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "deploy/*"
          target: "/home/spherulitic/.config/containers/systemd/"
          strip_components: 1

      - name: Copy mongo config files
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.HOST_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "lexicon-db/*"
          target: "/var/lib/xerafin/"
          strip_components: 1

      - name: Reload systemd and restart all services
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.HOST_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Reload systemd to pick up unit file changes
            systemctl --user daemon-reload

            # Restart all services
            systemctl --user restart xerafin.target

            # Quick status check
            echo "Service status"
            systemctl --user --no-pager status xerafin.target --all

            # Fixing a nonstandard dev configuration
            find ~/.config/containers/systemd/ -name '*.container' -exec sed -i 's|--runtime=/home/linuxbrew/.linuxbrew/bin/crun|--runtime=/usr/bin/crun|g' {} \;
